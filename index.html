<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 
    <script type="text/javascript" src="./src/d3/d3.js"></script>
    <script type="text/javascript" src="./src/jsonDatabase.js"></script>
    <script type="text/javascript" src="./src/sets.js"></script>
    <!-- <script type="text/javascript" src="./src/lazyRowConstruction.js"></script> -->
    <!-- <script type="text/javascript" src="./src/closure-generation-utils.js"></script> -->
    <script type="text/javascript" src="./src/Trie.js"></script>
    <script type="text/javascript" src="./src/search.js"></script>
    <!-- <script type="text/javascript" src="./src/Column.js"></script> -->
    <script type="text/javascript" src="./src/CategoryIndex.js"></script>
    <script type="text/javascript" src="./src/NumberIndex.js"></script>
    <script type="text/javascript" src="./src/stopwords.js"></script>
    <script type="text/javascript" src="./src/TextIndex.js"></script> 
    <script type="text/javascript" src="./src/DateIndex.js"></script>
    <script type="text/javascript" src="./src/Codebook.js"></script>
    <script type="text/javascript" src="./src/csv-utils.js"></script>
    <script type="text/javascript" src="./src/Dataset.js"></script> 
    <script type="text/javascript" src="./src/PreparedStatement.js"></script>
    <script type="text/javascript" src="./src/Palette.js"></script>

	<style type="text/css">

		div, span .label {
			font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  			font-size: 12px;
		}
		span .dateRange {
			font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  			font-size: 12px;
			background-color:#b4cdcd;
		}
		table {
	  		table-layout: fixed;
	  		border-collapse: collapse;
	  		width: 100%;
		}

		table td, th {
			font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  			font-size: 12px;
		}

		table td.dateCol, table th.dateCol {
    		width: 100px;
		}

		table td.placeCol, table th.placeCol {
    		width: 100px;
		}

		table td.descCol, table th.descCol {
    		width: 500px;
		}

        .axis path,
        .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

      	.tick line {
    		stroke: lightgrey;
    		opacity: 0.7;
    		stroke-width: 1;
		}

		.brush .extent {
  			stroke: #fff;
  			fill-opacity: .125;
  			shape-rendering: crispEdges;
		}

	</style>

		<script type="text/javascript">
		
		//"../SCAD_2.0_downloadable_version_v2_hugified.csv"
		
		//should this involve "onload" or some such?

d3.text("./SCAD_2.0_downloadable_version_v2.csv", function(datasetText) {
		
		jsonDatabase.csvToJsonArray(

				datasetText, 
				
				{ 
					"etype": {
                   				'1' : 'Organized Demonstration',
		                        '2' : 'Spontaneous Demonstration',
		                        '3' : 'Organized Violent Riot',
		                        '4' : 'Spontaneous Violent Riot',
		                        '5' : 'General Strike',
		                        '6' : 'Limited Strike',
		                        '7' : 'Pro-Government Violence (Repression)',
		                        '8' : 'Anti-Government Violence',
		                        '9' : 'Extra-government Violence',
		                        '10' : 'Intra-government Violence'
		            		}
        		}, 

				function(jsonArray) {

					dataset = new jsonDatabase.Dataset();

		    		dataset.loadData(

					  jsonArray,

	                  {
      			          eventid: 	 { header: "eventid", 	  columnType: jsonDatabase.NumberIndex},
                   		  countryname:  { header: "countryname", columnType: jsonDatabase.CategoryIndex}, 
                   		  startdate:    { header: "startdate",   columnType: jsonDatabase.DateIndex}, 
                   		  enddate:      { header: "enddate",     columnType: jsonDatabase.DateIndex},
                   		  etype:        { header: "etype", 	  columnType: jsonDatabase.CategoryIndex},
                   		  issuenote:    { header: "issuenote",   columnType: jsonDatabase.TextIndex}
                  	  });

              		//shouldn't need to explictly include the psWheres in creating a preparedstmt
					ps = new jsonDatabase.PreparedStatement.PreparedStatement(
							dataset, 
							jsonDatabase.PreparedStatement.psIntersection(
								jsonDatabase.PreparedStatement.psWhere("etype"), 
								jsonDatabase.PreparedStatement.psWhere("countryname"),
								jsonDatabase.PreparedStatement.psWhere("startdate"),
								jsonDatabase.PreparedStatement.psWhere("issuenote")
								),
							function(resultArr) { 
								redrawTable("dataTable", resultArr);
							});

					function fillSelect(idName,columnName) {
              		  		var s = document.getElementById(idName);
              		  		//var opts = dataset.getValues(columnName);
              		  		var opts = dataset.columnsObj[columnName].getValues();
					  		for(var i = 0; i < opts.length; i++) {
					  			if(opts[i] !== "-9") {  //total special case
					  				s.options[s.options.length] = new Option(opts[i], opts[i]);
					  			}
					  		}
					}
					fillSelect("selectIncidentType", "etype");
					fillSelect("selectPlaceName", "countryname");

					document.getElementById("selectIncidentType")
						.addEventListener("change", function() { newMultiSelect(this,ps,"etype"); });

					document.getElementById("selectPlaceName")
						.addEventListener("change", function() { newMultiSelect(this,ps,"countryname"); });

					document.getElementById("inputDescription")
						.addEventListener("keyup", function() { newTextInput(this,ps,"issuenote"); });

					p = new Palette();

        dimensions = { width: 700, height: 40 }
        padding    = { outerPaddingWidth: 5, placenameWidth: 70, innerPaddingWidth: 5,
                       outerPaddingHeight: 2, labelHeight: 10, tickToLabelHeight: 3, tickHeight: 5, 
                       axisToIncidentsHeight: 5 }
        corners    = { xTimelineLeft: padding.outerPaddingWidth + padding.placenameWidth + padding.innerPaddingWidth,
                       xTimelineRight: dimensions.width - padding.outerPaddingWidth,
                       yTimelineTop: padding.outerPaddingHeight,
                       yTimelineBottom: dimensions.height - (padding.outerPaddingHeight + padding.labelHeight + padding.tickToLabelHeight + padding.tickHeight) }

							var cnames = dataset.columnsObj.countryname.getValues().sort();
							countryOffsets = {};
							for(var i = 0, n = cnames.length; i < n; i++) {
								countryOffsets[cnames[i]] = i * dimensions.height;

							}
    						var maxOffset = i * dimensions.height;

    						totalHeight = maxOffset + dimensions.height;

							chart = d3.select("body").append("svg")
    							.attr("class", "chart")
    							.attr("width", dimensions.width)
    							.attr("height", maxOffset + dimensions.height + 10 + 40 + 30);  //last 30 is arbitrary

    						var dateFormat = d3.time.format("%d-%b-%y");
            				xScale = (function() {
                            	return d3.time.scale()
                                        .domain([dateFormat.parse("1-Jan-95").getTime(), dateFormat.parse("1-Jan-05").getTime()])
                                        .range([corners.xTimelineLeft, corners.xTimelineRight])
                                        .clamp(true);
                          	})();

                          	var selectorScale = d3.time.scale().range([corners.xTimelineLeft, corners.xTimelineRight]),
								selectorAxis = d3.svg.axis().scale(selectorScale).orient("bottom");
							selectorScale.domain([dateFormat.parse("1-Jan-89"), dateFormat.parse("31-Dec-10")]);

							for(var i = 0, n = cnames.length; i < n; i++) {
    							chart.append("text")
    							   .text(cnames[i])
    							   .attr("x", padding.outerPaddingWidth)
    							   .attr("y", i * dimensions.height + (dimensions.height / 3))
                                   .attr("font-size", dimensions.height / 4)
                                   .attr("font-family", "sans-serif");
                            }

            				chart.append("g")
            				     .attr("class", "axis")
            				     .attr("transform", "translate(0," + (maxOffset + corners.yTimelineBottom) + ")")
	                             .style("font-size", padding.labelHeight)
	                             .style("font-family", "sans-serif");
       
    						chart.select("g")
				                .call(d3.svg.axis()
				                  .scale(xScale)
				                  .tickFormat(d3.time.format("%b %Y"))
				                  .ticks(5)
				                  .orient("bottom")
				                  .tickSize(-totalHeight)
				                  //.tickSize(padding.tickHeight)
				                  .tickPadding(padding.tickToLabelHeight));
		
			    		    function brushed() {
 								//x.domain(brush.empty() ? x2.domain() : brush.extent());
  								//focus.select("path").attr("d", area);
  								//focus.select(".x.axis").call(xAxis);

								var dateFormat = d3.time.format("%d-%b-%y");
								var ext = brush.extent();

								//made at least temporarily global so can use in reDraw
								startDate = ext[0].getTime(); 
								endDate = ext[1].getTime();
								ps.evaluate("startdate", [dateFormat(ext[0]), dateFormat(ext[1])]);
							}

				            brush = d3.svg.brush()
    								  .x(selectorScale)
    								  .on("brush", brushed);

							context = chart.append("g")
    							.attr("transform", "translate(" + 0 + "," + (maxOffset + dimensions.height + 10) + ")");

    						context.append("rect")
							      .attr("x", corners.xTimelineLeft)
							      .attr("width", corners.xTimelineRight - corners.xTimelineLeft)
							      .attr("y", (maxOffset + dimensions.height + 10))
							      .attr("height", 30);
							     
							/*context.append("path")
							      .datum(data)
							      .attr("d", area2);
							*/
							context.append("g")
							      .attr("class", "axis")
							      .attr("transform", "translate(0," + 30 + ")")
							      .style("font-size", padding.labelHeight)
	                              .style("font-family", "sans-serif")
							      //.attr("transform", "translate(0," + (maxOffset + dimensions.height + 10 + 35) + ")")
							      .call(selectorAxis);

							context.append("g")
							      .attr("class", "x brush")
							      .call(brush)
							    .selectAll("rect")
							      .attr("y", -6)
							      .attr("height", 30); //maxOffset + dimensions.height + 10 + 7);

	                  })});

		function newTextInput(inputObj, preparedStmt, label) {
			preparedStmt.evaluate(label, [inputObj.value]);
		}

		function newMultiSelect(selectObj, preparedStmt, label) {
			var options = [];
			for (var i = 0, n = selectObj.length; i < n; i++) {
	            if (selectObj[i].selected) {
					var which = selectObj.options[i].value;
					options.push(which);
				}
			}
			preparedStmt.evaluate(label, options);
		}

		function redrawTable(parentElement, resultArr) {

			var dateFormat = d3.time.format("%d-%b-%y");

			if(resultArr.length !== 0) {
				xScale = (function() {
	            	return d3.time.scale()
	            			//startDate and endDate being set as globals by newRangeInput
	                        .domain([startDate, endDate])
	                        .range([corners.xTimelineLeft, corners.xTimelineRight])
	                        .clamp(true);
	          	})();
	        }

			//var chart = d3.select("body").select("svg");

			chart.select("g")
                .call(d3.svg.axis()
                  .scale(xScale)
                  .tickFormat(d3.time.format("%b %Y"))
                  .ticks(5)
                  .orient("bottom")
				  .tickSize(-totalHeight)
                  //.tickSize(padding.tickHeight)
                  .tickPadding(padding.tickToLabelHeight));


			var cs = chart.selectAll("circle")
			  .data(resultArr, function(d) { return d.eventid; });
			//data, enter, and exit return arrays. their internal formats are not entirely trivial,
			//but it is presumably possible to partition them and invoke, at least, the insert operations
			//using setTimeout of requestAnimationFrame to break up rendering
			//OR: I can use d3 for scales, etc., but simply implement my own enter/exit/update functions
			//OR: If broken up by country (by me), d3 might be able to handle those subsets adequately
			cs.enter().insert("circle")
			  .attr("cx", function(d, i) { return xScale(dateFormat.parse(d.startdate).getTime()); })
			  .attr("cy", function(d) { return countryOffsets[d.countryname] + corners.yTimelineBottom - padding.axisToIncidentsHeight; })
			  .attr("r", 4)
			  .attr("fill", function(d) { return p.getColor(d.etype); })
			  .insert("svg:title")   //or .append?
                .text(function(d) { 
                        return d.countryname + '(' + d.startdate + '): ' + d.issuenote; 
                      });

            cs.attr("cx", function(d, i) { return xScale(dateFormat.parse(d.startdate).getTime()); });  //.transition()
              

			cs.exit().remove();


			/*
			var format = d3.time.format("%d-%b-%y");
			var displayedTable = document.getElementById(parentElement);
			for(var i = 0, n = resultArr.length; i < n; i++) {
	        	var r = resultArr[i];
				var newDiv = document.createElement("div");
				newDiv.setAttribute("id", r.eventid);
				newDiv.setAttribute("data-milliseconds", format.parse(r.startdate).getTime());
				newDiv.setAttribute("class", "label");
			    var newContent = document.createTextNode(r.countryname + " (" + r.startdate + "): " + r.issuenote);
				newDiv.appendChild(newContent);
				displayedTable.appendChild(newDiv);	        	
	        }
	       */
		}

	</script>
</head>
<body>


<form id="queryForm" style="width: 100%; float: left;">
	<span>
		<div style="float:left;">
			<span class="label">Incident Type:</span><br/>
			<select id="selectIncidentType" multiple="yes"></select>
		</div>
		<div style="float:left;">
			<span class="label">Country:</span><br/>
			<select id="selectPlaceName" multiple="yes"></select>
		</div>

		<div style="float:left;">
			<span class="label">Description:</span><br/>
			<input type="text" id="inputDescription">
		</div>
	</span>
</form>	

<br/>
<div id="dataTable" style="width: 100%; float: left;">

</div>

</body>
</html>